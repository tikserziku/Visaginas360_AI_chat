'use strict';

document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const voiceButton = document.getElementById('voice-button');
    const chatMessages = document.getElementById('chat-messages');
    const voiceModal = document.getElementById('voice-modal');
    const closeModal = document.querySelector('.close');
    const startVoiceBtn = document.getElementById('start-voice');
    const voiceText = document.getElementById('voice-text');
    const loadingIndicator = document.getElementById('loading-indicator');
    const menuButton = document.getElementById('menuButton');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const brandName = document.querySelector('.brand-name');
    const aboutLink = document.querySelector('[href="#about"]');
    const settingsLink = document.querySelector('[href="#settings"]');
    const helpLink = document.querySelector('[href="#help"]');

    let recognition = null;
    let isRecording = false;
    let translations = {};
    let currentRecognitionLang = 'lt-LT'; // –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ –ª–∏—Ç–æ–≤—Å–∫–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    loadTranslations();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
    function initSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            voiceButton.style.display = 'none';
            console.log('Speech Recognition API is not supported');
            return;
        }

        const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
        recognition = new SpeechRecognition();
        
        // –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = currentRecognitionLang;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        recognition.onstart = () => {
            isRecording = true;
            startVoiceBtn.classList.add('recording');
            voiceText.textContent = translations.voice_listening || 'Listening...';
        };

        recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            if (text.trim()) {
                addMessage(text, true);
                hideVoiceModal();
                sendMessage(text);
            }
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            voiceText.textContent = translations.voice_error || 'Error. Please try again.';
            isRecording = false;
            startVoiceBtn.classList.remove('recording');
        };

        recognition.onend = () => {
            isRecording = false;
            startVoiceBtn.classList.remove('recording');
            voiceText.textContent = translations.voice_modal_text || 'Click to speak';
        };
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
    function toggleRecognition() {
        if (!recognition) {
            initSpeechRecognition();
        }

        if (!isRecording) {
            recognition.lang = currentRecognitionLang;
            recognition.start();
        } else {
            recognition.stop();
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
    voiceButton.addEventListener('click', showVoiceModal);
    closeModal.addEventListener('click', hideVoiceModal);
    startVoiceBtn.addEventListener('click', toggleRecognition);

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞
    const languageButton = document.createElement('button');
    languageButton.className = 'input-button language-button';
    languageButton.textContent = 'üåê';
    languageButton.addEventListener('click', () => {
        // –¶–∏–∫–ª–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —è–∑—ã–∫–∞–º–∏
        const languages = ['lt-LT', 'ru-RU', 'en-US'];
        const currentIndex = languages.indexOf(currentRecognitionLang);
        const nextIndex = (currentIndex + 1) % languages.length;
        currentRecognitionLang = languages[nextIndex];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —è–∑—ã–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        if (recognition) {
            recognition.lang = currentRecognitionLang;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —è–∑—ã–∫
        const languageNames = {
            'lt-LT': 'LT',
            'ru-RU': 'RU',
            'en-US': 'EN'
        };
        languageButton.setAttribute('title', `Current: ${languageNames[currentRecognitionLang]}`);
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —è–∑—ã–∫–∞ –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    voiceButton.parentNode.insertBefore(languageButton, voiceButton);
});
